<!DOCTYPE html>
<html>
<head>
    <title>Gezelle Netwerk Visualisatie</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* Oplossing voor 'onzichtbaarheid': de container MOET een hoogte en breedte hebben */
        #mynetwork {
            width: 100%;
            height: 600px; /* Vaste hoogte zodat het netwerk zichtbaar is */
            border: 1px solid lightgray;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
        }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .controls { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; background-color: #f9f9f9; }
        .controls label, .controls input { margin-right: 20px; }
    </style>
</head>
<body>

    <h1>Netwerk Visualisatie</h1>

    <div class="controls">
        <label for="startYear">Start Jaar:</label>
        <input type="number" id="startYear" value="1870" min="1800" max="1950" onchange="filterAndDraw()">

        <label for="endYear">Eind Jaar:</label>
        <input type="number" id="endYear" value="1890" min="1800" max="1950" onchange="filterAndDraw()">
        
        <p style="margin-top: 10px;">Gefilterde knooppunten: <strong id="nodeCount">0</strong> | Gefilterde randen: <strong id="edgeCount">0</strong></p>
    </div>

    <div id="mynetwork"></div>

    <script type="text/javascript">
        // Globale variabelen om de onbewerkte data op te slaan
        let allNodes = [];
        let allEdges = [];
        let network = null;
        const container = document.getElementById('mynetwork');

        // Configuraties voor Vis.js
        const options = {
            nodes: {
                shape: 'dot',
                size: 10,
                font: { size: 12, color: '#333' },
                borderWidth: 2
            },
            edges: {
                arrows: 'to',
                color: { inherit: true },
                smooth: { type: 'continuous' }
            },
            physics: {
                // Basisinstellingen voor een overzichtelijke layout
                enabled: true,
                barnesHut: {
                    gravitationalConstant: -2000,
                    centralGravity: 0.3,
                    springLength: 95,
                    springConstant: 0.04
                },
                solver: 'barnesHut',
                // Zorg ervoor dat de fysica stopt zodra het netwerk stabiel is
                stabilization: { enabled: true, iterations: 1000 }
            }
        };

        /**
         * Laadt en parseert beide CSV-bestanden.
         */
        async function loadData() {
            try {
                // Laad Nodes data - AANGEPASTE NAAM: nodes.csv
                const nodesData = await parseCSV('nodes.csv');
                allNodes = nodesData.map(d => ({
                    id: d.ID,
                    label: d.Label,
                    group: d.Category, // Gebruik Categorie voor kleurgroepering
                    title: `Type: ${d.Category}\nStart: ${d.Startyearcor}\nEind: ${d.EndYearcor}`,
                    startYear: parseInt(d.Startyearcor),
                    endYear: parseInt(d.EndYearcor)
                }));

                // Laad Edges data - AANGEPASTE NAAM: edges.csv
                const edgesData = await parseCSV('edges.csv');
                allEdges = edgesData.map(d => ({
                    from: d.source,
                    to: d.target,
                    label: d.rolLabel,
                    title: `Relatie: ${d.rolLabel}\nJaar: ${d.FinalStartyear}-${d.FinalEndYear}`,
                    startYear: parseInt(d.FinalStartyear),
                    endYear: parseInt(d.FinalEndYear)
                }));
                
                // Start de visualisatie zodra de data geladen is
                filterAndDraw();

            } catch (error) {
                console.error("Fout bij het laden van de bestanden:", error);
                // Deze foutmelding wordt alleen getoond als het ophalen van de data mislukt (bijv. 404)
                container.innerHTML = "Kon de netwerkdata niet laden. Controleer of de bestanden **'nodes.csv'** en **'edges.csv'** correct zijn en op GitHub staan.";
            }
        }

        /**
         * Utility functie om een CSV-bestand te parsen met PapaParse.
         * @param {string} url - Het pad naar het CSV-bestand.
         */
        function parseCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.errors.length > 0) {
                            console.error(`Fouten bij het parsen van ${url}:`, results.errors);
                            reject(results.errors);
                        } else {
                            // Controleer op een lege dataset na het parsen
                            if (results.data.length === 0) {
                                console.warn(`CSV-bestand ${url} is leeg of kon niet correct worden geparst.`);
                                reject(new Error("Leeg of ongeldig CSV-bestand."));
                            } else {
                                resolve(results.data);
                            }
                        }
                    },
                    error: (error) => reject(error)
                });
            });
        }

        /**
         * Filtert de randen op basis van de geselecteerde jaren en tekent het netwerk.
         */
        function filterAndDraw() {
            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);

            if (isNaN(startYear) || isNaN(endYear)) return;

            // 1. Filter de Edges
            const filteredEdges = allEdges.filter(edge => {
                // De rand is actief als: EdgeStart <= SelectEnd EN EdgeEnd >= SelectStart
                return edge.startYear <= endYear && edge.endYear >= startYear;
            });

            // 2. Bepaal de Nodes die verbonden zijn door de gefilterde Edges
            const connectedNodeIds = new Set();
            filteredEdges.forEach(edge => {
                connectedNodeIds.add(edge.from);
                connectedNodeIds.add(edge.to);
            });

            // 3. Filter de Nodes (toon alleen verbonden nodes)
            const filteredNodes = allNodes.filter(node => {
                return connectedNodeIds.has(node.id);
            });
            
            // 4. Update de tellers
            document.getElementById('nodeCount').textContent = filteredNodes.length;
            document.getElementById('edgeCount').textContent = filteredEdges.length;

            // 5. Creëer de Vis.js data structuur
            const data = {
                nodes: new vis.DataSet(filteredNodes),
                edges: new vis.DataSet(filteredEdges)
            };

            // 6. Teken of update het netwerk
            if (network) {
                // Als het netwerk al bestaat, update de data
                network.setData(data);
            } else {
                // Eerste keer: creëer het netwerk
                network = new vis.Network(container, data, options);
            }
        }

        // Start het proces door de data te laden
        loadData();
    </script>

</body>
</html>